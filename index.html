<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Photobooth App with Emoji Stickers</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0; background: #f5f8ff;
    display: flex; flex-direction: column; align-items: center;
  }
  h1 {
    margin: 20px 0 10px 0;
    color: #333;
  }
  #page1, #page2, #page3 {
    width: 320px;
    border: 1px solid #ccc;
    background: white;
    border-radius: 8px;
    margin-bottom: 20px;
    padding: 10px;
  }
  #page1 {
    text-align: center;
  }
  #page1 input[type=file] {
    margin: 10px 0;
  }
  #photoStrip {
    position: relative;
    width: 300px;
    height: 240px;
    margin: 10px auto;
    border: 2px solid #aaa;
    background: #eee;
    overflow: hidden;
    border-radius: 6px;
  }
  #photoStrip img {
    width: 100px;
    height: 140px;
    object-fit: cover;
    margin: 4px 2px;
    border-radius: 4px;
    border: 1px solid #bbb;
  }
  #stickersLayer {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: auto;
  }
  #emojiPalette {
    margin-top: 10px;
    display: flex;
    justify-content: center;
    gap: 10px;
  }
  .emoji {
    font-size: 26px;
    cursor: grab;
    user-select: none;
  }
  .sticker {
    position: absolute;
    font-size: 26px;
    cursor: grab;
    user-select: none;
    touch-action: none;
  }
  .dragging {
    cursor: grabbing !important;
  }
  #filters {
    margin-top: 10px;
    text-align: center;
  }
  select {
    padding: 4px;
    font-size: 14px;
  }
  #textInput {
    width: 90%;
    margin: 8px auto;
    display: block;
    padding: 6px;
    font-size: 14px;
    border: 1px solid #aaa;
    border-radius: 4px;
  }
  button {
    margin: 8px 4px;
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
    border-radius: 4px;
    border: none;
    background: #4a90e2;
    color: white;
    transition: background 0.3s;
  }
  button:hover {
    background: #357ab8;
  }
</style>
</head>
<body>

<h1>Photobooth App</h1>

<!-- Page 1: Upload photos -->
<div id="page1">
  <h2>Upload up to 3 photos</h2>
  <input type="file" id="fileInput" accept="image/*" multiple />
  <div id="photoStrip"></div>
  <button id="toPage2Btn">Next: Add Stickers</button>
</div>

<!-- Page 2: Stickers and filters -->
<div id="page2" style="display:none;">
  <h2>Add Emoji Stickers & Filters</h2>
  <div id="photoStrip" style="position:relative; width:300px; height:240px; margin:auto; border:2px solid #aaa; background:#eee; border-radius:6px; overflow:hidden;">
    <div id="stickersLayer"></div>
  </div>
  <div id="filters">
    <label for="filterSelect">Filter: </label>
    <select id="filterSelect">
      <option value="none">None</option>
      <option value="grayscale(100%)">Grayscale</option>
      <option value="sepia(60%)">Sepia</option>
      <option value="contrast(150%)">High Contrast</option>
      <option value="brightness(120%)">Brighten</option>
      <option value="blur(2px)">Blur</option>
    </select>
  </div>
  <div id="emojiPalette" title="Drag emojis onto the photos">
    <!-- Emojis inserted by JS -->
  </div>
  <button id="toPage3Btn">Next: Add Text & Download</button>
  <button id="backToPage1Btn">Back</button>
</div>

<!-- Page 3: Add text and download -->
<div id="page3" style="display:none;">
  <h2>Add Text & Download</h2>
  <div id="photoStrip" style="position:relative; width:300px; height:240px; margin:auto; border:2px solid #aaa; background:#eee; border-radius:6px; overflow:hidden;">
    <div id="stickersLayer"></div>
  </div>
  <input type="text" id="textInput" placeholder="Enter caption or message here" maxlength="50" />
  <div style="text-align:center;">
    <button id="downloadBtn">Download Image</button>
    <button id="backToPage2Btn">Back</button>
  </div>
</div>

<script>
  // Elements
  const fileInput = document.getElementById('fileInput');
  const photoStripPage1 = document.querySelector('#page1 #photoStrip');
  const photoStripPage2 = document.querySelector('#page2 #photoStrip');
  const photoStripPage3 = document.querySelector('#page3 #photoStrip');
  const stickersLayerPage2 = document.querySelector('#page2 #stickersLayer');
  const stickersLayerPage3 = document.querySelector('#page3 #stickersLayer');
  const filterSelect = document.getElementById('filterSelect');
  const emojiPalette = document.getElementById('emojiPalette');
  const textInput = document.getElementById('textInput');
  const downloadBtn = document.getElementById('downloadBtn');

  // Pages and buttons
  const page1 = document.getElementById('page1');
  const page2 = document.getElementById('page2');
  const page3 = document.getElementById('page3');
  const toPage2Btn = document.getElementById('toPage2Btn');
  const toPage3Btn = document.getElementById('toPage3Btn');
  const backToPage1Btn = document.getElementById('backToPage1Btn');
  const backToPage2Btn = document.getElementById('backToPage2Btn');

  let uploadedImages = [];
  let emojis = ['ðŸ’–','ðŸ’™','ðŸ¤','ðŸŒ¸','âœ¨','ðŸ’«','ðŸŽ€','â„ï¸','ðŸŽ‰','ðŸ’¡','ðŸ’Œ','ðŸ’Ž','â­','ðŸŽˆ']; // Pink, blue, white themed emojis

  // Helper: Clear children
  function clearChildren(element) {
    while (element.firstChild) {
      element.removeChild(element.firstChild);
    }
  }

  // Load photos to page 1 strip
  fileInput.addEventListener('change', (e) => {
    const files = e.target.files;
    if (files.length > 3) {
      alert('Please upload up to 3 photos only.');
      fileInput.value = '';
      return;
    }
    uploadedImages = [];
    clearChildren(photoStripPage1);
    for (let i=0; i < files.length; i++) {
      const file = files[i];
      const img = document.createElement('img');
      img.file = file;
      photoStripPage1.appendChild(img);

      const reader = new FileReader();
      reader.onload = ((aImg) => (e) => {
        aImg.src = e.target.result;
        uploadedImages.push(e.target.result);
      })(img);
      reader.readAsDataURL(file);
    }
  });

  // Move to page 2
  toPage2Btn.addEventListener('click', () => {
    if (uploadedImages.length === 0) {
      alert('Please upload at least one photo to continue.');
      return;
    }
    page1.style.display = 'none';
    page2.style.display = 'block';
    page3.style.display = 'none';

    // Load images into page 2 photo strip with stickersLayer
    clearChildren(photoStripPage2);
    clearChildren(stickersLayerPage2);

    uploadedImages.forEach(src => {
      const img = document.createElement('img');
      img.src = src;
      img.style.margin = '4px 2px';
      img.style.width = '100px';
      img.style.height = '140px';
      img.style.objectFit = 'cover';
      img.style.borderRadius = '4px';
      photoStripPage2.appendChild(img);
    });

    // Copy stickers from previous page3 if any
    clearChildren(stickersLayerPage2);

    // Reset filter
    photoStripPage2.style.filter = 'none';
    filterSelect.value = 'none';

    // Populate emoji palette
    clearChildren(emojiPalette);
    emojis.forEach(emoji => {
      const span = document.createElement('span');
      span.textContent = emoji;
      span.className = 'emoji';
      span.title = "Drag me!";
      span.addEventListener('mousedown', (e) => {
        e.preventDefault();
        const sticker = createEmojiSticker(emoji);
        const rect = stickersLayerPage2.getBoundingClientRect();
        sticker.style.left = (e.clientX - rect.left - 14) + 'px';
        sticker.style.top = (e.clientY - rect.top - 14) + 'px';
        stickersLayerPage2.appendChild(sticker);
      });
      span.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = stickersLayerPage2.getBoundingClientRect();
        const sticker = createEmojiSticker(emoji);
        sticker.style.left = (touch.clientX - rect.left - 14) + 'px';
        sticker.style.top = (touch.clientY - rect.top - 14) + 'px';
        stickersLayerPage2.appendChild(sticker);
      }, { passive: false });
      emojiPalette.appendChild(span);
    });
  });

  // Move to page 3
  toPage3Btn.addEventListener('click', () => {
    page1.style.display = 'none';
    page2.style.display = 'none';
    page3.style.display = 'block';

    // Show photos with stickers on page3
    clearChildren(photoStripPage3);
    clearChildren(stickersLayerPage3);

    uploadedImages.forEach(src => {
      const img = document.createElement('img');
      img.src = src;
      img.style.margin = '4px 2px';
      img.style.width = '100px';
      img.style.height = '140px';
      img.style.objectFit = 'cover';
      img.style.borderRadius = '4px';
      photoStripPage3.appendChild(img);
    });

    // Copy stickers from page 2 to page 3
    stickersLayerPage2.querySelectorAll('.sticker').forEach(sticker => {
      const clone = sticker.cloneNode(true);
      stickersLayerPage3.appendChild(clone);
      addDragHandlers(clone, stickersLayerPage3);
    });

    // Apply filter from page 2
    photoStripPage3.style.filter = photoStripPage2.style.filter;

    // Clear text input
    textInput.value = '';
  });

  backToPage1Btn.addEventListener('click', () => {
    page1.style.display = 'block';
    page2.style.display = 'none';
    page3.style.display = 'none';
  });

  backToPage2Btn.addEventListener('click', () => {
    page1.style.display = 'none';
    page2.style.display = 'block';
    page3.style.display = 'none';
  });

  // Filter change
  filterSelect.addEventListener('change', (e) => {
    photoStripPage2.style.filter = e.target.value;
  });

  // Create draggable emoji sticker element
  function createEmojiSticker(emoji) {
    const span = document.createElement('span');
    span.textContent = emoji;
    span.className = 'sticker';
    span.style.left = '10px';
    span.style.top = '10px';
    addDragHandlers(span, stickersLayerPage2);
    return span;
  }

  // Add drag handlers to a sticker
  function addDragHandlers(element, container) {
    let dragging = false;
    let offsetX, offsetY;

    element.addEventListener('mousedown', (e) => {
      dragging = true;
      offsetX = e.clientX - element.offsetLeft;
      offsetY = e.clientY - element.offsetTop;
      element.classList.add('dragging');
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (dragging) {
        let left = e.clientX - offsetX;
        let top = e.clientY - offsetY;
        left = Math.min(Math.max(left, 0), container.clientWidth - element.offsetWidth);
        top = Math.min(Math.max(top, 0), container.clientHeight - element.offsetHeight);
        element.style.left = left + 'px';
        element.style.top = top + 'px';
      }
    });

    document.addEventListener('mouseup', () => {
      if (dragging) {
        dragging = false;
        element.classList.remove('dragging');
      }
    });

    // Touch support
    element.addEventListener('touchstart', (e) => {
      dragging = true;
      const touch = e.touches[0];
      offsetX = touch.clientX - element.offsetLeft;
      offsetY = touch.clientY - element.offsetTop;
      element.classList.add('dragging');
      e.preventDefault();
    }, { passive: false });

    document.addEventListener('touchmove', (e) => {
      if (dragging) {
        const touch = e.touches[0];
        let left = touch.clientX - offsetX;
        let top = touch.clientY - offsetY;
        left = Math.min(Math.max(left, 0), container.clientWidth - element.offsetWidth);
        top = Math.min(Math.max(top, 0), container.clientHeight - element.offsetHeight);
        element.style.left = left + 'px';
        element.style.top = top + 'px';
      }
    }, { passive: false });

    document.addEventListener('touchend', () => {
      if (dragging) {
        dragging = false;
        element.classList.remove('dragging');
      }
    });
  }

  // Add drag handlers to stickers on page 3 as well (for clones)
  stickersLayerPage3.addEventListener('mousedown', e => {
    if (e.target.classList.contains('sticker')) {
      addDragHandlers(e.target, stickersLayerPage3);
    }
  });

  // Download button logic: merge photos, stickers, and text
  downloadBtn.addEventListener('click', () => {
    const canvas = document.createElement('canvas');
    canvas.width = 300;
    canvas.height = 240;
    const ctx = canvas.getContext('2d');

    // Clear
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Draw photos side by side
    const photoWidth = 100;
    const photoHeight = 140;
    uploadedImages.forEach((src, i) => {
      const img = new Image();
      img.src = src;
      // We have to wait for all images to load before drawing
      img.onload = () => {
        ctx.drawImage(img, i*photoWidth + 2, 4, photoWidth - 4, photoHeight);
        // After last image loaded, draw stickers and text
        if (i === uploadedImages.length -1) {
          drawStickersAndText();
        }
      };
    });

    // If no images (should not happen), still draw stickers/text
    if (uploadedImages.length === 0) {
      drawStickersAndText();
    }

    // Draw stickers and text on canvas
    function drawStickersAndText() {
      // Draw stickers
      const stickers = stickersLayerPage3.querySelectorAll('.sticker');
      stickers.forEach(sticker => {
        const style = window.getComputedStyle(sticker);
        const fontSize = parseInt(style.fontSize);
        const left = parseFloat(sticker.style.left);
        const top = parseFloat(sticker.style.top);
        ctx.font = fontSize + "px serif";
        ctx.fillText(sticker.textContent, left, top + fontSize);
      });

      // Draw text input
      const text = textInput.value.trim();
      if (text) {
        ctx.font = "20px Arial";
        ctx.fillStyle = "#222";
        ctx.textAlign = "center";
        ctx.fillText(text, canvas.width/2, canvas.height - 20);
      }

      // Apply filter? Not applying as canvas has no direct CSS filter support

      // Save/download
      const dataURL = canvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.download = 'photobooth_image.png';
      link.href = dataURL;
      link.click();
    }
  });
</script>

</body>
</html>
